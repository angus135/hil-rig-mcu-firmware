# CubeIDE Firmware Project

This directory contains the **STM32CubeIDE-generated firmware project**. Its responsibilities are:

- Initialising hardware (clocks, GPIO, peripherals)
- Configuring middleware
- Calling the **application entry point** implemented outside this directory
- Hosting all STM32 HAL, LL, BSP and middleware code generated by STM32CubeMX

All **application logic** lives in the top-level repository under `../src/`. Which can be accessed in this project in STM32CubeIDE through `Core/Src/Application/`

This separation ensures CubeMX code generation does not overwrite application code.

---

## Directory Structure

Typical contents of this directory:

- `Core/`
  - `Src/`, `Inc/`
  - `main.c`, `stm32xx_it.c`, `freertos.c`, etc.
- `Drivers/`
  - `STM32xx_HAL_Driver/`, BSP, CMSIS
- `Middlewares/`
- `Startup/`
- `<project>.ioc` (CubeMX configuration file)
- `.project`, `.cproject` (CubeIDE metadata)
- `README.md` (this file)

Everything in this directory is considered **CubeIDE/CubeMX–owned**.  
Application code must not be added here.

---

## Architecture Overview

High-level structure of the firmware:

- CubeIDE project (this directory):
  - Hardware initialisation
  - HAL and middleware configuration
  - Calls into the external application

- External application (in `../src/`):
  - `app_main` module with `APP_MAIN_Application()`
  - Other modules (drivers, logic, state machines, utilities)
  - Unit-testable, hardware-agnostic code

Control flow typically looks like:

1. `main()` in `Core/Src/main.c` is executed after reset.
2. HAL and system clocks are initialised.
3. GPIO and other peripherals configured by CubeMX are initialised.
4. The user application entry point is called:

```c
APP_MAIN_Application();
```

5. All application behaviour runs via code in `../src/`. `main()` should never be returned to

---

## Using External Application Code (`../src`)

The application code lives in the outer `src/` directory at the repository root. This CubeIDE project only references that code.

### Include Paths

The CubeIDE project is configured with:

```
../src
```

via:

**Project → Properties → C/C++ General → Paths and Symbols → Includes**

This allows:

```c
#include "app_main.h"
#include "module_name.h"
```

without modifying generated files.

### Linking Source Files from `src`

To compile external `.c` files, the `src` folder must be linked into the CubeIDE project:

1. Right-click the CubeIDE project in the Project Explorer.
2. Select **New → Folder**.
3. Click **Advanced >>**.
4. Select **Link to alternate location (Linked Folder)**.
5. Set the location to:

```
../src
```

6. Enable:

```
Add folder to build
```

7. Click **Finish**.

CubeIDE will now:

- Compile every `.c` file inside `src/**`
- Detect new modules automatically
- Leave application code untouched during CubeMX regenerations

To verify a file is included in the build:

Right-click the file → **Properties → C/C++ Build → Resource Configurations**  
Ensure **Exclude from build** is **unchecked**.

---

## Entry Point Handover

CubeIDE’s autogenerated `main.c` hands control to the application:

```c
APP_MAIN_Application();
```

from within a `/* USER CODE BEGIN */` region.  
From here on, execution occurs entirely in the code under `../src`.

Guidelines:

- Do not add application logic to `main.c` except this handover
- Only modify CubeIDE-generated files inside `USER CODE` blocks

---

## What Belongs Where

| Location | Responsibility | Owned By | Regenerated? |
|---------|---------------|---------|-------------|
| CubeIDE project directory | HAL, startup, peripherals, scheduler | CubeMX | Yes |
| `../src/app_main` | Application entry | Developer | No |
| `../src/<module>` | Business logic, drivers, state machines | Developer | No |
| `../tests/` | Host-side unit tests | Developer | N/A |

**Rule of thumb:**

- If it configures hardware or HAL → **here**
- If it implements logic, state, or behaviour → **src/**

---

## Regeneration Safety

It is safe to regenerate code via CubeMX at any time provided:

- Application code remains in `../src`
- Only `USER CODE` blocks are modified in generated files
- No `.c` files are added under `Core/`, `Drivers/`, or `Middlewares/`

---

## Unit Testing and Host Builds

Unit tests are built and executed **outside** CubeIDE using CMake and Docker.

CubeIDE is used **only** for:

- Target firmware builds
- Hardware debugging
- CubeMX-driven peripheral configuration

---
